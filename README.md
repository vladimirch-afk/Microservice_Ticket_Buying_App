# Чечуров Владимир Сергеевич, БПИ227, ДЗ 4М. Система заказов по покупку билетов

## Решение

Было разработано 2 микросервиса: `application`, `authentication` (у каждого своя БД), выполняющие следующие функции:

### authentication:

- Регистрация пользователя (POST http://localhost:8080/auth/create?userName=&email=&password=), принимает в качестве аргументов имя пользователя, почту пользователя и пароль. Возвращает сообщение об удачности операции.
- Логирование пользователя (GET http://localhost:8080/auth/login?email=&password=), принимает в качестве аргументов почту пользователя и пароль. Возвращает текущий токен пользователя (примерно через полминуты, его действия истекает и надо логироваться заново).
- Получение информации о пользователе (GET http://localhost:8080/info/:token), в адресе принимает токен пользователя. Возвращает информацию о пользователе, если токен действителен, иначе, сообщение об ошибке.

### application:

- Покупка билета (POST http://localhost:8081/app/buy?from=&to=), принимает в качестве аргументов станцию отправления и станцию назначения. В `Header` необходимо будет указать токен, как `jwt: {значение токена}`. Возвращает ID заказа.
- Проверка статуса заказа (GET http://localhost:8081/app/check?orderId=), принимает в качестве аргументов аргументов принимает ID заказа. В `Header` необходимо будет указать токен, как `jwt: {значение токена}`. Возвращает информацию о заказе.

## Принцип работы

При необходимости выполнения операций регистрации, логирования пользователя и получения информации о пользователе, происходит запрос в микросервис `authentication`, который при необходимости обращается к своей БД `auth-db`.

При выполнении запросов в микросервис `application`, он сначала получает информацию о пользователе через токен от микросервиса `authentication`. Далее выполняет обработка запроса, при необходимости обращаясь к БД `app-bd` (для удобства проверки работы, туда при создании таблиц, добавляется 3 станции: S1, S2, S3).

В `application` находится `OrderStatusChanger`, который каждые 10 секунд извлекает из БД все заказы, которые имеют статус "check", и с 50% шансом меняет их на "success" или "rejected".

В обоих микросервисах в классе `GlobalExceptionHandler` происходит обработка исключений и перевод их в сообщения пользователю с разными кодами ответов.

## Запуск

Перед запуском следует собрать артефакты `*.jar` в соответствующие папки. Для `authentification` в `docker/authentication` для рядом с `Dockerfile` (имя артефакта должно быть `authentication-0.0.1-SNAPSHOT.jar`). Для `application` в `docker/application` для рядом с `Dockerfile` (имя артефакта должно быть `application-0.0.1-SNAPSHOT.jar`). 

`Dockerfile` для баз данных находятся в папках `auth-bd` и `app-bd`.

После сбора артефактов и перемещения их в необходимые папки можно поднять все приложение через консольную команду `docker compose up `.

Коллекция для `Postman` находится в файле `Ticket-Service.postman_collection.json`.
